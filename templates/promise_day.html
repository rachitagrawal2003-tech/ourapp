{% extends 'base.html' %}

{% block title %}Promise Day - Feb 11{% endblock %}

{% block extra_css %}
<style>
    .parchment {
        background-color: #f4e4bc;
        background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.4'/%3E%3C/svg%3E");
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.2) inset, 0 10px 20px rgba(0, 0, 0, 0.3);
    }

    .fingerprint-scan {
        background: linear-gradient(to bottom, transparent, #ec4899, transparent);
        height: 2px;
        width: 100%;
        position: absolute;
        top: 0;
        animation: scan 1.5s linear infinite;
        display: none;
    }

    @keyframes scan {
        0% {
            top: 0;
        }

        100% {
            top: 100%;
        }
    }

    .holding .fingerprint-scan {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="flex flex-col items-center justify-center min-h-[80vh] w-full px-4">

    <!-- Contract Container -->
    <div id="contract"
        class="parchment p-8 md:p-12 max-w-2xl w-full rounded-sm text-gray-800 relative transform transition-all duration-700">
        <h1 class="text-4xl md:text-5xl font-dancing text-center mb-8 border-b-2 border-gray-400 pb-4">
            Promise of Love
        </h1>

        <div class="font-poppins leading-relaxed text-lg mb-8 space-y-4">
            <p>I hereby promise to:</p>
            <ul class="list-disc pl-6 italic">
                <li>Love you unconditionally.</li>
                <li>Always be your biggest supporter.</li>
                <li>Share my fries with you (mostly).</li>
                <li>Never go to sleep angry.</li>
            </ul>
        </div>

        <div class="flex flex-col items-center justify-center mt-12">
            <p class="mb-4 text-sm uppercase tracking-widest text-gray-600">Hold to Sign</p>

            <!-- Fingerprint Scanner -->
            <div id="fingerprint-btn"
                class="relative w-24 h-24 rounded-full border-4 border-gray-300 flex items-center justify-center cursor-pointer select-none overflow-hidden transition-colors duration-300">
                <i class="fas fa-fingerprint text-5xl text-gray-400 transition-colors duration-300"></i>
                <div class="fingerprint-scan"></div>

                <!-- Progress Ring SVG -->
                <svg class="absolute inset-0 w-full h-full rotate-[-90deg]">
                    <circle cx="50%" cy="50%" r="46%" fill="none" stroke="#ec4899" stroke-width="4"
                        stroke-dasharray="290" stroke-dashoffset="290" id="progress-ring"
                        class="transition-all duration-75"></circle>
                </svg>
            </div>
        </div>

        <!-- Success Seal -->
        <div id="seal" class="absolute bottom-8 right-8 hidden animate-bounce">
            <div
                class="bg-red-800 text-white rounded-full w-24 h-24 flex items-center justify-center shadow-lg border-4 border-red-600 rotate-12">
                <span class="font-dancing text-xl font-bold">Signed</span>
            </div>
        </div>
    </div>

    <!-- Download Button (Hidden initially) -->
    <button id="download-btn"
        class="mt-8 bg-valentine-600 hover:bg-valentine-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transform scale-0 transition-transform duration-500 flex items-center gap-2">
        <i class="fas fa-file-download"></i> Download Contract
    </button>

</div>

<script>
    const btn = document.getElementById('fingerprint-btn');
    const ring = document.getElementById('progress-ring');
    const seal = document.getElementById('seal');
    const downloadBtn = document.getElementById('download-btn');
    const icon = btn.querySelector('i');

    let progress = 0;
    let timer = null;
    let isSigned = false;
    const requiredTime = 3000; // 3 seconds
    const intervalTime = 50;

    function startHold(e) {
        if (isSigned) return;
        e.preventDefault();
        btn.classList.add('holding', 'border-valentine-500');
        icon.classList.remove('text-gray-400');
        icon.classList.add('text-valentine-500');

        timer = setInterval(() => {
            progress += (intervalTime / requiredTime) * 290; // 290 is circumference approx
            const offset = 290 - progress;
            ring.style.strokeDashoffset = Math.max(0, offset);

            if (offset <= 0) {
                complete();
            }
        }, intervalTime);
    }

    function endHold() {
        if (isSigned) return;
        clearInterval(timer);
        btn.classList.remove('holding', 'border-valentine-500');
        icon.classList.add('text-gray-400');
        icon.classList.remove('text-valentine-500');

        // Reset
        progress = 0;
        ring.style.transition = 'stroke-dashoffset 0.3s';
        ring.style.strokeDashoffset = 290;
        setTimeout(() => ring.style.transition = 'none', 300);
    }

    function complete() {
        clearInterval(timer);
        isSigned = true;
        btn.classList.remove('holding');

        // Success State
        icon.classList.remove('fa-fingerprint', 'text-valentine-500');
        icon.classList.add('fa-check', 'text-green-500');
        ring.style.stroke = '#22c55e';

        // Show Seal
        seal.classList.remove('hidden');

        // Show Download Button
        downloadBtn.classList.remove('scale-0');
        downloadBtn.classList.add('scale-100');

        // Trigger confetti? Why not.
        // Re-use logic or simple version? Simple version for now.
    }

    btn.addEventListener('mousedown', startHold);
    btn.addEventListener('touchstart', startHold);

    window.addEventListener('mouseup', endHold);
    window.addEventListener('touchend', endHold);

    downloadBtn.addEventListener('click', () => {
        window.print();
    });
</script>
{% endblock %}